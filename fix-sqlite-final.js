const fs = require("fs");
const path = require("path");

const sitePath = "C:\\Users\\BJIT\\PressBox\\sites\\bjit";
const wpConfigPath = path.join(sitePath, "wp-config.php");

console.log("ðŸ”§ Creating final SQLite configuration...\n");

// Create proper wp-config.php with DB_ENGINE set to 'sqlite'
const newConfig = `<?php
/**
 * The base configuration for WordPress with SQLite
 *
 * This file contains the following configurations:
 * * Database settings (SQLite)
 * * Secret keys
 * * Database table prefix
 * * ABSPATH
 *
 * This has been generated by PressBox
 */

// ** CRITICAL: Set database engine to SQLite ** //
// This MUST be defined before anything else
define( 'DB_ENGINE', 'sqlite' );

// ** SQLite Database Configuration ** //
define( 'DB_DIR', dirname( __FILE__ ) . '/wp-content/database/' );
define( 'DB_FILE', '.ht.sqlite' );

// These are required by WordPress but not used by SQLite
define( 'DB_NAME', 'bjit' );
define( 'DB_USER', '' );
define( 'DB_PASSWORD', '' );
define( 'DB_HOST', '' );
define( 'DB_CHARSET', 'utf8' );
define( 'DB_COLLATE', '' );

/**#@+
 * Authentication unique keys and salts.
 * Change these to different unique phrases!
 * You can generate these using: https://api.wordpress.org/secret-key/1.1/salt/
 */
define( 'AUTH_KEY',         'put your unique phrase here' );
define( 'SECURE_AUTH_KEY',  'put your unique phrase here' );
define( 'LOGGED_IN_KEY',    'put your unique phrase here' );
define( 'NONCE_KEY',        'put your unique phrase here' );
define( 'AUTH_SALT',        'put your unique phrase here' );
define( 'SECURE_AUTH_SALT', 'put your unique phrase here' );
define( 'LOGGED_IN_SALT',   'put your unique phrase here' );
define( 'NONCE_SALT',       'put your unique phrase here' );

/**#@-*/

/**
 * WordPress database table prefix.
 */
$table_prefix = 'wp_';

/**
 * WordPress debugging mode.
 */
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
define( 'WP_DEBUG_DISPLAY', false );

/**
 * WordPress site URLs
 */
define( 'WP_HOME', 'http://localhost:8000' );
define( 'WP_SITEURL', 'http://localhost:8000' );

/* Add any custom values between this line and the "stop editing" line. */

/* That's all, stop editing! Happy publishing. */

/** Absolute path to the WordPress directory. */
if ( ! defined( 'ABSPATH' ) ) {
    define( 'ABSPATH', __DIR__ . '/' );
}

/** Sets up WordPress vars and included files. */
require_once ABSPATH . 'wp-settings.php';
`;

// Write the new config
fs.writeFileSync(wpConfigPath, newConfig);
console.log("âœ… wp-config.php updated with DB_ENGINE = sqlite");

// Ensure database directory exists
const dbDir = path.join(sitePath, "wp-content", "database");
if (!fs.existsSync(dbDir)) {
    fs.mkdirSync(dbDir, { recursive: true });
    console.log("âœ… Created database directory");
} else {
    console.log("âœ… Database directory exists");
}

// Create .htaccess to protect database directory
const htaccessPath = path.join(dbDir, ".htaccess");
fs.writeFileSync(htaccessPath, "Deny from all");
console.log("âœ… Created .htaccess for database protection");

// Verify db.php exists
const dbPhpPath = path.join(sitePath, "wp-content", "db.php");
if (fs.existsSync(dbPhpPath)) {
    console.log("âœ… db.php drop-in exists");
} else {
    console.log("âŒ db.php drop-in is MISSING!");
    console.log("   It should have been copied from the plugin.");
}

// Verify plugin exists
const pluginPath = path.join(
    sitePath,
    "wp-content",
    "plugins",
    "sqlite-database-integration"
);
if (fs.existsSync(pluginPath)) {
    console.log("âœ… SQLite Integration plugin is installed");
} else {
    console.log("âŒ SQLite Integration plugin is MISSING!");
}

console.log("\nðŸŽ‰ SQLite configuration is complete!");
console.log("\nðŸ“‹ Now do this:");
console.log("   1. In PressBox, STOP the bjit site");
console.log("   2. Then START it again");
console.log('   3. Click "Open Site" to visit http://localhost:8000');
console.log("   4. You should see the WordPress installation wizard!");
console.log("\nðŸ’¡ The database file will be created at:");
console.log("   wp-content/database/.ht.sqlite");
